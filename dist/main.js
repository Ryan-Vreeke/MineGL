(()=>{var e={398:e=>{Noise={},Noise.SimplexNoise=function(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());for(this.perm=[],t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]},Noise.SimplexNoise.prototype.dot=function(e,t,i){return e[0]*t+e[1]*i},Noise.SimplexNoise.prototype.dot3=function(e,t,i,s){return e[0]*t+e[1]*i+e[2]*s},Noise.SimplexNoise.prototype.noise=function(e,t){var i,s,r=(e+t)*(.5*(Math.sqrt(3)-1)),a=Math.floor(e+r),n=Math.floor(t+r),o=(3-Math.sqrt(3))/6,h=(a+n)*o,c=e-(a-h),u=t-(n-h);c>u?(i=1,s=0):(i=0,s=1);var d=c-i+o,l=u-s+o,f=c-1+2*o,p=u-1+2*o,m=255&a,v=255&n,g=this.perm[m+this.perm[v]]%12,y=this.perm[m+i+this.perm[v+s]]%12,b=this.perm[m+1+this.perm[v+1]]%12,w=.5-c*c-u*u,x=.5-d*d-l*l,M=.5-f*f-p*p;return 70*((w<0?0:(w*=w)*w*this.dot(this.grad3[g],c,u))+(x<0?0:(x*=x)*x*this.dot(this.grad3[y],d,l))+(M<0?0:(M*=M)*M*this.dot(this.grad3[b],f,p)))},Noise.SimplexNoise.prototype.noise3d=function(e,t,i){var s,r,a,n,o,h,c=(e+t+i)*(1/3),u=Math.floor(e+c),d=Math.floor(t+c),l=Math.floor(i+c),f=1/6,p=(u+d+l)*f,m=e-(u-p),v=t-(d-p),g=i-(l-p);m>=v?v>=g?(s=1,r=0,a=0,n=1,o=1,h=0):m>=g?(s=1,r=0,a=0,n=1,o=0,h=1):(s=0,r=0,a=1,n=1,o=0,h=1):v<g?(s=0,r=0,a=1,n=0,o=1,h=1):m<g?(s=0,r=1,a=0,n=0,o=1,h=1):(s=0,r=1,a=0,n=1,o=1,h=0);var y=m-s+f,b=v-r+f,w=g-a+f,x=m-n+2*f,M=v-o+2*f,S=g-h+2*f,k=m-1+.5,A=v-1+.5,P=g-1+.5,T=255&u,B=255&d,_=255&l,U=this.perm[T+this.perm[B+this.perm[_]]]%12,C=this.perm[T+s+this.perm[B+r+this.perm[_+a]]]%12,z=this.perm[T+n+this.perm[B+o+this.perm[_+h]]]%12,G=this.perm[T+1+this.perm[B+1+this.perm[_+1]]]%12,E=.6-m*m-v*v-g*g,D=.6-y*y-b*b-w*w,N=.6-x*x-M*M-S*S,O=.6-k*k-A*A-P*P;return 32*((E<0?0:(E*=E)*E*this.dot3(this.grad3[U],m,v,g))+(D<0?0:(D*=D)*D*this.dot3(this.grad3[C],y,b,w))+(N<0?0:(N*=N)*N*this.dot3(this.grad3[z],x,M,S))+(O<0?0:(O*=O)*O*this.dot3(this.grad3[G],k,A,P)))},e.exports=Noise}},t={};function i(s){var r=t[s];if(void 0!==r)return r.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,i),a.exports}(()=>{"use strict";const e="struct TransformationData {\n  view: mat4x4<f32>,\n  projection: mat4x4<f32>\n};\n\nstruct ObjectData {\n  model: array<mat4x4<f32>>,\n};\n\nstruct Fragment {\n  @builtin(position) Position: vec4<f32>,\n  @location(0) TexCoord: vec2<f32>\n};\n\n@binding(0) @group(0) var<uniform> transformUBO : TransformationData;\n@binding(1) @group(0) var<storage, read> objects: ObjectData;\n@binding(2) @group(0) var myTexture: texture_2d<f32>;\n@binding(3) @group(0) var mySampler: sampler;\n\n@vertex\nfn vs_main(@builtin(instance_index) ID: u32, @location(0) vertexPostion: vec3<f32>, @location(1) vertexTexCoord: vec2<f32>) -> Fragment {\n\n    var output: Fragment;\n    output.Position = transformUBO.projection * transformUBO.view * objects.model[ID] * vec4<f32>(vertexPostion, 1.0);\n    output.TexCoord = vertexTexCoord;\n\n    return output;\n}\n\n@fragment\nfn fs_main(@location(0) TexCoord: vec2<f32>) -> @location(0) vec4<f32> {\n  return textureSample(myTexture, mySampler, TexCoord);\n}\n";class t{constructor(e){const t=new Float32Array([.5,-.5,.5,1,0,-.5,-.5,.5,0,0,-.5,-.5,-.5,0,1,.5,-.5,-.5,1,1,.5,-.5,.5,1,0,-.5,-.5,-.5,0,1]),i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,s={size:t.byteLength,usage:i,mappedAtCreation:!0};this.buffer=e.createBuffer(s),new Float32Array(this.buffer.getMappedRange()).set(t),this.buffer.unmap(),this.bufferLayout={arrayStride:20,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var s=1e-6,r="undefined"!=typeof Float32Array?Float32Array:Array;function a(){var e=new r(16);return r!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var n=function(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{h(s.next(e))}catch(e){a(e)}}function o(e){try{h(s.throw(e))}catch(e){a(e)}}function h(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}h((s=s.apply(e,t||[])).next())}))};class o{initialize(e,t){return n(this,void 0,void 0,(function*(){const i=yield fetch(t),s=yield i.blob(),r=yield createImageBitmap(s);yield this.loadImageBitmap(e,r),this.view=this.texture.createView({format:"rgba8unorm",dimension:"2d",aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}),this.sampler=e.createSampler({addressModeU:"repeat",addressModeV:"repeat",magFilter:"nearest",minFilter:"linear",mipmapFilter:"nearest",maxAnisotropy:1})}))}loadImageBitmap(e,t){return n(this,void 0,void 0,(function*(){const i={size:{width:t.width,height:t.height},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};this.texture=e.createTexture(i),e.queue.copyExternalImageToTexture({source:t},{texture:this.texture},i.size)}))}}var h=function(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{h(s.next(e))}catch(e){a(e)}}function o(e){try{h(s.throw(e))}catch(e){a(e)}}function h(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}h((s=s.apply(e,t||[])).next())}))};class c{constructor(e,t){this.canvas=e,this.objCount=t}Initialize(){return h(this,void 0,void 0,(function*(){yield this.setupDevice(),yield this.createAssets(),yield this.makeDepthBufferResources(),yield this.makePipeline()}))}setupDevice(){return h(this,void 0,void 0,(function*(){this.adapter=yield navigator.gpu.requestAdapter(),this.device=yield this.adapter.requestDevice(),this.context=this.canvas.getContext("webgpu"),this.format=navigator.gpu.getPreferredCanvasFormat(),this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}))}makeDepthBufferResources(){return h(this,void 0,void 0,(function*(){this.depthStencilState={format:"depth24plus-stencil8",depthWriteEnabled:!0,depthCompare:"less-equal"};const e={size:{width:this.canvas.width,height:this.canvas.height,depthOrArrayLayers:1},format:"depth24plus-stencil8",usage:GPUTextureUsage.RENDER_ATTACHMENT};this.depthStencilBuffer=this.device.createTexture(e),this.depthStencilView=this.depthStencilBuffer.createView({format:"depth24plus-stencil8",dimension:"2d",aspect:"all"}),this.depthStencilAttachment={view:this.depthStencilView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store",stencilLoadOp:"clear",stencilStoreOp:"discard"}}))}makePipeline(){return h(this,void 0,void 0,(function*(){this.uniformBuffer=this.device.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const t=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage",hasDynamicOffset:!1}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]});this.bindGroup=this.device.createBindGroup({layout:t,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:{buffer:this.objectBuffer}},{binding:2,resource:this.material.view},{binding:3,resource:this.material.sampler}]});const i=this.device.createPipelineLayout({bindGroupLayouts:[t]});this.pipeline=this.device.createRenderPipeline({layout:i,depthStencil:this.depthStencilState,vertex:{module:this.device.createShaderModule({code:e}),entryPoint:"vs_main",buffers:[this.faceMesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:e}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list",cullMode:"back"}})}))}createAssets(){return h(this,void 0,void 0,(function*(){this.faceMesh=new t(this.device),this.material=new o,yield this.material.initialize(this.device,"dist/textures/grass_block_side.png");const e={size:64*this.objCount*6,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST};this.objectBuffer=this.device.createBuffer(e)}))}render(e,t,i){return h(this,void 0,void 0,(function*(){const s=a();var r,n,o,h,c,u,d;r=s,n=Math.PI/4,o=800/600,h=.1,c=1e3,d=1/Math.tan(n/2),r[0]=d/o,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=d,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,null!=c&&c!==1/0?(u=1/(h-c),r[10]=(c+h)*u,r[14]=2*c*h*u):(r[10]=-1,r[14]=-2*h),this.device.queue.writeBuffer(this.objectBuffer,0,e,0,e.length),this.device.queue.writeBuffer(this.uniformBuffer,0,i.get_model()),this.device.queue.writeBuffer(this.uniformBuffer,64,s);const l=this.device.createCommandEncoder(),f={colorAttachments:[{view:this.context.getCurrentTexture().createView(),clearValue:[.44,.7,1,1],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:this.depthStencilAttachment},p=l.beginRenderPass(f);p.setPipeline(this.pipeline),p.setVertexBuffer(0,this.faceMesh.buffer),p.setBindGroup(0,this.bindGroup),p.draw(6,t,0,0),p.end(),this.device.queue.submit([l.finish()])}))}}function u(){var e=new r(3);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function d(e,t,i,s){return e[0]=t[0]+i[0]*s,e[1]=t[1]+i[1]*s,e[2]=t[2]+i[2]*s,e}function l(e,t,i){var s=t[0],r=t[1],a=t[2],n=i[0],o=i[1],h=i[2];return e[0]=r*h-a*o,e[1]=a*n-s*h,e[2]=s*o-r*n,e}function f(e){return e*Math.PI/180}u();class p{constructor(e,t,i){this.position=e,this.eulers=[0,i,t],this.forwards=u(),this.up=u(),this.right=u()}update(){this.forwards=[Math.cos(f(this.eulers[2]))*Math.cos(f(this.eulers[1])),Math.sin(f(this.eulers[2]))*Math.cos(f(this.eulers[1])),Math.sin(f(this.eulers[1]))],l(this.right,this.forwards,[0,0,1]),l(this.up,this.right,this.forwards);var e,t,i,r=u();e=r,t=this.position,i=this.forwards,e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],this.model=a(),function(e,t,i,r){var a,n,o,h,c,u,d,l,f,p,m=t[0],v=t[1],g=t[2],y=r[0],b=r[1],w=r[2],x=i[0],M=i[1],S=i[2];Math.abs(m-x)<s&&Math.abs(v-M)<s&&Math.abs(g-S)<s?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(d=m-x,l=v-M,f=g-S,a=b*(f*=p=1/Math.hypot(d,l,f))-w*(l*=p),n=w*(d*=p)-y*f,o=y*l-b*d,(p=Math.hypot(a,n,o))?(a*=p=1/p,n*=p,o*=p):(a=0,n=0,o=0),h=l*o-f*n,c=f*a-d*o,u=d*n-l*a,(p=Math.hypot(h,c,u))?(h*=p=1/p,c*=p,u*=p):(h=0,c=0,u=0),e[0]=a,e[1]=h,e[2]=d,e[3]=0,e[4]=n,e[5]=c,e[6]=l,e[7]=0,e[8]=o,e[9]=u,e[10]=f,e[11]=0,e[12]=-(a*m+n*v+o*g),e[13]=-(h*m+c*v+u*g),e[14]=-(d*m+l*v+f*g),e[15]=1)}(this.model,this.position,r,this.up)}get_model(){return this.model}}class m{constructor(e){this.position=e,this.faces=[],this.faces.push(new v([e[0],e[1],e[2]],[f(0),f(0),f(-90)])),this.faces.push(new v([e[0],e[1],e[2]],[0,0,f(180)])),this.faces.push(new v([e[0],e[1],e[2]],[0,f(0),0])),this.faces.push(new v([e[0],e[1],e[2]],[f(0),f(0),f(90)])),this.faces.push(new v([e[0],e[1],e[2]],[f(-90),0,0])),this.faces.push(new v([e[0],e[1],e[2]],[f(90),0,0]))}get_faces(){return this.faces}}class v{constructor(e,t){var i,s,r,n,o,h,c,u,d,l,f,p,m,v,g,y,b,w;this.position=e,this.model=a(),i=this.model,s=this.model,y=(r=this.position)[0],b=r[1],w=r[2],s===i?(i[12]=s[0]*y+s[4]*b+s[8]*w+s[12],i[13]=s[1]*y+s[5]*b+s[9]*w+s[13],i[14]=s[2]*y+s[6]*b+s[10]*w+s[14],i[15]=s[3]*y+s[7]*b+s[11]*w+s[15]):(n=s[0],o=s[1],h=s[2],c=s[3],u=s[4],d=s[5],l=s[6],f=s[7],p=s[8],m=s[9],v=s[10],g=s[11],i[0]=n,i[1]=o,i[2]=h,i[3]=c,i[4]=u,i[5]=d,i[6]=l,i[7]=f,i[8]=p,i[9]=m,i[10]=v,i[11]=g,i[12]=n*y+u*b+p*w+s[12],i[13]=o*y+d*b+m*w+s[13],i[14]=h*y+l*b+v*w+s[14],i[15]=c*y+f*b+g*w+s[15]),function(e,t,i){var s=Math.sin(i),r=Math.cos(i),a=t[4],n=t[5],o=t[6],h=t[7],c=t[8],u=t[9],d=t[10],l=t[11];t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*r+c*s,e[5]=n*r+u*s,e[6]=o*r+d*s,e[7]=h*r+l*s,e[8]=c*r-a*s,e[9]=u*r-n*s,e[10]=d*r-o*s,e[11]=l*r-h*s}(this.model,this.model,t[0]),function(e,t,i){var s=Math.sin(i),r=Math.cos(i),a=t[0],n=t[1],o=t[2],h=t[3],c=t[8],u=t[9],d=t[10],l=t[11];t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*r-c*s,e[1]=n*r-u*s,e[2]=o*r-d*s,e[3]=h*r-l*s,e[8]=a*s+c*r,e[9]=n*s+u*r,e[10]=o*s+d*r,e[11]=h*s+l*r}(this.model,this.model,t[1]),function(e,t,i){var s=Math.sin(i),r=Math.cos(i),a=t[0],n=t[1],o=t[2],h=t[3],c=t[4],u=t[5],d=t[6],l=t[7];t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*r+c*s,e[1]=n*r+u*s,e[2]=o*r+d*s,e[3]=h*r+l*s,e[4]=c*r-a*s,e[5]=u*r-n*s,e[6]=d*r-o*s,e[7]=l*r-h*s}(this.model,this.model,t[2])}get_model(){return this.model}}class g{constructor(e,t,i){this.blocks=new Array(i*i),this.offset=i/2,this.size=i,this.x=e,this.y=t}createChunk(e){for(var t=Math.floor(this.size/2),i=-t;i<t;i++)for(var s=-t;s<t;s++){const t=this.x*this.size+i,a=this.y*this.size+s,n=e(t,a);var r=new m([t,a,n]);this.blocks[(i+this.offset)*this.size+(s+this.offset)]=r}}}var y=i(398);class b{constructor(e,t){this.chunkSize=e,this.center=t/2,this.mapSize=t,this.chunks=new Array(t*t),this.blocks=[],this.faces=[],this.simplex=new y.SimplexNoise,this.lacunarity=2,this.persistance=.5}createChunk(e,t){(e>=this.mapSize-1||t>=this.mapSize-1)&&(this.mapSize+=2);let i=new g(e,t,this.chunkSize);i.createChunk(((e,t)=>0));const s=e+this.center,r=t+this.center;return this.chunks[s*this.mapSize+r]=i,i.blocks.forEach((e=>{this.faces.push(...e.get_faces())})),i}getChunk(e,t){const i=e+this.center,s=t+this.center;return this.chunks[i*this.mapSize+s]}octave(e,t,i){let s=Math.pow(this.lacunarity,i),r=Math.pow(this.persistance,i);return this.simplex.noise(e/150*s,t/150*s)*r}getBlocks(){return this.blocks}getFaces(){return this.faces}getObjectData(){const e=new Float32Array(16*this.mapSize*this.mapSize*this.chunkSize*this.chunkSize*6);var t=0;return this.faces.forEach((i=>{for(var s=i.get_model(),r=0;r<16;r++)e[16*t+r]=s.at(r);t++})),e}}class w{constructor(e,t){this.chunkCount=e,this.chunkSize=t;const i=t*t*(e*e)*6;this.player=new p([-20,0,10],0,0),this.mapGen=new b(t,e);const s=Math.floor(e/2);for(var r=-s;r<=s;r++)for(var a=-s;a<=s;a++)this.mapGen.createChunk(r,a);this.object_data=this.mapGen.getObjectData(),this.object_count=i}update(){this.player.update()}get_blocks(){return this.object_data}get_player(){return this.player}player_move(e,t){d(this.player.position,this.player.position,this.player.forwards,t),d(this.player.position,this.player.position,this.player.right,e)}player_look(e,t){this.player.eulers[2]-=e,this.player.eulers[2]%=360,this.player.eulers[1]=Math.min(89,Math.max(-89,this.player.eulers[1]+t))}}const x=document.querySelector("canvas"),M=new class{constructor(e){this.run=()=>{this.scene.update(),this.scene.player_move(this.sideAmount*this.scale,this.forwardAmount*this.scale),this.renderer.render(this.scene.get_blocks(),this.scene.object_count,this.scene.get_player()),requestAnimationFrame(this.run)},this.canvas=e,this.renderer=new c(e,2304),this.renderer.Initialize(),this.scene=new w(3,16),this.forwardAmount=0,this.sideAmount=0,this.scale=.5,document.addEventListener("keydown",this.keyDown.bind(this)),document.addEventListener("keyup",this.keyUp.bind(this)),this.canvas.onclick=()=>{this.canvas.requestPointerLock()},this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this))}handleMouseMove(e){this.scene.player_look(e.movementX/10,e.movementY/-10)}keyUp(e){this.forwardAmount=0,this.sideAmount=0}keyDown(e){switch(e.key){case"w":this.forwardAmount=1;break;case"a":this.sideAmount=-1;break;case"s":this.forwardAmount=-1;break;case"d":this.sideAmount=1}}}(x);M.run()})()})();